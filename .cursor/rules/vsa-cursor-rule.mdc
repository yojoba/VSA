---
alwaysApply: true
---

# FlowBiz.ai — Cursor Project Rules (vsa-cursor-rule.mdc)

## 0) Scope & Voice
- Project: **FlowBiz VPS Admin Suite** for multi-tenant hosting on Infomaniak VPS (primary) and Kamatera (legacy).
- Goals: Fast, secure deployment of **AI apps (Dify, n8n, local LLMs)** and **customer websites** via Docker.
- Default language for code/comments/commits: **English**.
- Timezone & locale assumptions: **Europe/Zurich**, Swiss conventions where relevant.

## 1) Architecture & Baseline Assumptions
- OS: Ubuntu 22.04 LTS/24.04 LTS.
- Container runtime: **Docker + Docker Compose v2**.
- Reverse proxy: **NGINX** (containerized) fronting all services via per-site upstreams, HTTP on `:4480`, HTTPS on `:4443` if a shared ingress is needed; otherwise standard `80/443` when VPS owns the public IP directly.
- TLS: Prefer **wildcard certificates** already owned by FlowBiz. Fallback to Let's Encrypt (HTTP-01 or DNS-01).
- Networking: Dedicated user-defined bridge networks per stack + one **shared external network** `flowbiz_ext` for reverse proxy.
- Data paths: `/srv/<tenant>/<app>/{data,env,compose,logs}` with root-owned dirs and app-specific user if needed.
- Git model: **Monorepo** with `apps/`, `stacks/`, `packages/`, `infra/`, `docs/`.
- Git strategy: **Trunk-based** with short-lived branches, **Conventional Commits**, **SemVer** tags.

## 2) Repository Layout (Monorepo)
```
/ (repo root)
  .cursor/vsa-cursor-rule.mdc           # ← this file
  .editorconfig
  .gitignore
  Makefile
  /infra                    # Ansible/Terraform + bootstrap scripts
    ansible/
    scripts/bootstrap_vps.sh
    scripts/new_stack.sh
  /stacks                   # Docker Compose stacks (n8n, dify, reverse-proxy, tenants)
    reverse-proxy/
      compose.yml
      nginx/
        conf.d/*.conf
        snippets/*.conf
      certs/                # mount read-only (do NOT commit certs)
    n8n/
      compose.yml
      .env.example
    dify/
      compose.yml
      .env.example
    llm-gateway/
      compose.yml
    templates/              # opinionated compose templates
      compose.base.yml
      compose.postgres.yml
      compose.redis.yml
      compose.queue.yml
  /apps                     # in-house tools (CLI, API, UI)
    vps-admin-cli/          # Python Typer-based CLI
    vps-admin-api/          # FastAPI admin API
    vps-admin-ui/           # Next.js/React dashboard
  /packages
    python/
      common/
    js/
      ui-components/
  /docs
    ADRs/
    runbooks/
```

## 3) Security & Compliance Defaults
- **No secrets in repo.** Use `.env` files in `/srv/.../env/` and pass via compose; provide `.env.example` in repo.
- Restrict permissions: `chmod 640` for `.env`, owned by `root:docker` or app user.
- Enable **UFW** with only required ports (80/443 or 4480/4443; SSH 22; custom if needed).
- **Fail2ban** on SSH + NGINX.
- All public services behind reverse proxy with **rate-limits** and **security headers**.
- Add **healthchecks** for every container; restart policies `unless-stopped`.
- Backups: Define **restic** profiles to S3-compatible storage (Infomaniak Object Storage). Schedule via `cron` container.
- Logging: Forward NGINX access/error and app logs to `/srv/<tenant>/<app>/logs`. Optionally add Loki/Promtail later.

## 4) NGINX Reverse Proxy Rules
- One NGINX container maps to `flowbiz_ext` network; each app joins `flowbiz_ext` and exposes upstream as `http://<service>:<port>`.
- Each site gets a **vhost** file in `nginx/conf.d/` named `<domain>.conf`.
- Enforce `HSTS`, `X-Frame-Options DENY`, `X-Content-Type-Options nosniff`, `Referrer-Policy same-origin`.
- Force HTTPS redirect. HTTP used only for ACME challenges if LE is used.
- Wildcard certs mounted read-only at `/etc/nginx/certs/`.

### vhost snippet (template)
```
server {
  listen 80;
  server_name {{DOMAIN}};
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name {{DOMAIN}};

  ssl_certificate     /etc/nginx/certs/{{CERT_NAME}}.crt;
  ssl_certificate_key /etc/nginx/certs/{{CERT_NAME}}.key;

  include /etc/nginx/snippets/security_headers.conf;

  location /healthz { return 200 "ok"; add_header Content-Type text/plain; }

  location / {
    proxy_pass http://{{UPSTREAM}};
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 120s;
  }
}
```

## 5) Compose Conventions
- **Naming:** `project_name` = `<tenant>-<app>` (e.g., `flowbiz-n8n`, `clientx-website`).
- **Networks:** attach to `flowbiz_ext` for reverse-proxy access; create a local network `<tenant>-<app>-net` for internal services.
- **Volumes:** bind-mount `/srv/<tenant>/<app>/data` and `/srv/<tenant>/<app>/logs`.
- **Env:** mount `/srv/<tenant>/<app>/env/.env` to service; never commit real env.
- **Healthcheck example:**
```
healthcheck:
  test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
  interval: 30s
  timeout: 5s
  retries: 5
  start_period: 20s
```

## 6) Standard Makefile Targets (root & in stacks/)
```
.PHONY: bootstrap new-stack up down logs ps prune lint format test release
bootstrap: ## Install base tools on a fresh VPS
	./infra/scripts/bootstrap_vps.sh

new-stack: ## Create a new stack from template
	./infra/scripts/new_stack.sh $(name)

up:
	docker compose up -d --build

down:
	docker compose down

logs:
	docker compose logs -f --tail=200

ps:
	docker compose ps

prune:
	docker system prune -af --volumes

lint:
	hadolint **/Dockerfile || true
	ruff check apps/ packages/
	npx eslint apps/**/*.ts apps/**/*.tsx || true

format:
	ruff format apps/ packages/
	npx prettier -w "**/*.{ts,tsx,js,jsx,json,md,yml,yaml}"

test:
	pytest -q || true

release:
	./infra/scripts/release.sh
```

## 7) Language & Tooling Standards
### Python
- Package manager: **uv** or **poetry** (choose one per app; default to **uv** for speed).
- Lint: **ruff**; Format: **ruff format**.
- Test: **pytest**; App server (APIs): **FastAPI + Uvicorn**.
- CLI: **Typer**; Config via `.env` + Pydantic Settings.

### Node/TS
- Manager: **pnpm**; Runtime: **Node 20 LTS**; UI: **Next.js + Tailwind**.
- Lint: **eslint**; Format: **prettier**.

### Docker
- Base images slim; non-root users; pin major versions; add `HEALTHCHECK`.
- Multi-stage builds; `NODE_ENV=production`; `PYTHONDONTWRITEBYTECODE=1`, `PYTHONUNBUFFERED=1`.
- Keep images <300MB where possible.

## 8) App Blueprints
### n8n stack
- Single container + Postgres + Redis (optional) with backups.
- Expose `/healthz` via NGINX; set `N8N_HOST`, `N8N_PROTOCOL=https`, `N8N_PORT=5678`.
- Persist `/home/node/.n8n`.

### Dify stack
- `api`, `web`, `worker`, `sandbox` + Postgres + Redis + optional vector DB (Qdrant/Weaviate).
- NGINX routes `/`→web, `/v1/`→api; ensure `CORS` and `X-Accel-Buffering off` for streams.
- Provide `.env.example` tailored to single-VPS deployment (no Certbot, reuse wildcard certs).

### Customer website
- `web` (Next.js or NGINX static) + optional `api` + DB. Default to **Postgres**.
- All domains subpath-safe; prefer root-domain or subdomain per tenant.

## 9) Secrets & Config
- `.env.example` must include **only placeholders**; real `.env` lives in `/srv/.../env/.env`.
- For production, support **sops**-encrypted env files (optional) & a `decrypt_env.sh` helper.
- Use **open-ports minimalism**. No DB ports exposed publicly; reverse proxy only ingress.

## 10) Backups & Disaster Recovery
- restic profile per stack:
  - Include `data/` and DB dumps (via cron `pg_dump` to `data/backups/`).
  - Exclude caches/tmp.
  - Daily snapshot, 7 daily / 4 weekly / 6 monthly retention.
- Basic restore docs under `/docs/runbooks/restore.md`.

## 11) Observability
- Add lightweight `/healthz` endpoints to every service.
- Access logs enabled on NGINX; structured JSON logs for APIs (pino/loguru).
- Optional: Loki/Promtail + Grafana; else use `docker logs` + fail2ban reports.

## 12) Git & CI
- **Conventional Commits** (`feat:`, `fix:`, `chore:`, `docs:`, `refactor:`, `perf:`, `test:`).
- PR checks: `lint`, `test`, `build` for affected apps.
- Release: tag `vMAJ.MIN.PATCH`; changelog via `git-cliff` or `semantic-release`.

## 13) Cursor Agent Behaviors (VERY IMPORTANT)
- When generating new service stacks:
  1. Create `stacks/<name>/compose.yml`, `.env.example`, `README.md` and if needed `nginx/conf.d/<domain>.conf`.
  2. Ensure **healthchecks**, **restart policies**, **volumes**, **networks** as specified.
  3. Provide **Makefile** or extend root Makefile targets to include the new stack.
- When writing Dockerfiles: use multi-stage, non-root user, minimal layers, add `HEALTHCHECK`.
- When producing `.env.example`: include clear comments and defaults that work locally with Compose.
- When touching NGINX: include `security_headers.conf` and strict TLS.
- Always output commands to deploy:
  - `mkdir -p /srv/<tenant>/<app>/{data,env,logs}`
  - `cp stacks/<app>/.env.example /srv/<tenant>/<app>/env/.env` (then edit)
  - `docker compose -f stacks/<app>/compose.yml up -d`
- Prefer **idempotent** bash scripts (`set -Eeuo pipefail`) and clear logging (`echo "[step] ..."`).

## 14) Coding Style & Docs
- Each stack must have a **README.md** with: purpose, env vars, ports, volumes, networks, deploy steps, backup notes.
- Python: type hints mandatory (`mypy` optional), docstrings for public functions.
- JS/TS: strict TypeScript where possible; export clear interfaces.
- Avoid over-abstraction; keep ops-first simplicity.

## 15) Tenant Onboarding Template
- Create folder `/srv/<tenant>/<app>/` and provision vhost.
- Generate `.env` from template; set domain, cert name, upstream service.
- If DB required:
  - Create dedicated DB user/password.
  - Disable public DB ports; only internal network.
- Add backup job & verify initial snapshot.

## 16) Known Provider Notes
- **Infomaniak VPS**: prefer their Object Storage for restic targets; check MTU and default networking; allow outbound SMTP only via provider policy or use relay.
- **Kamatera** (legacy): keep parity but plan migration; avoid provider-specific quirks.

## 17) Quality Gates (Do not merge if)
- No `.env.example` present.
- No healthcheck in Dockerfile/compose.
- No README for a new stack.
- Exposes DB to the internet.
- NGINX vhost without security headers/HSTS.

## 18) Quick Commands (Cheatsheet)
```
# Bootstrap a fresh VPS
make bootstrap

# Bring up the reverse proxy (once)
cd stacks/reverse-proxy && make up

# New stack from template
make new-stack name=clientx-website

# Deploy stack
cd stacks/clientx-website && make up

# Tail logs
cd stacks/clientx-website && make logs
```

## 19) Future Enhancements (Roadmap)
- Add GitOps (Watchtower or FluxCD-lite approach) for safe image updates.
- Central auth (Authelia/Keycloak) in front of admin UIs.
- Metrics stack (Prometheus + cAdvisor + Grafana) kept optional.
- Automated per-tenant billing exports (usage, storage, domains).

## 20) Non-Goals
- No Kubernetes on these VPS initially; keep it **simple Docker**.
- Avoid heavyweight service meshes/ingress controllers.

# End of vsa-cursor-rule.mdc
# FlowBiz.ai — Cursor Project Rules (.cursorrules)

## 0) Scope & Voice
- Project: **FlowBiz VPS Admin Suite** for multi-tenant hosting on Infomaniak VPS (primary) and Kamatera (legacy).
- Goals: Fast, secure deployment of **AI apps (Dify, n8n, local LLMs)** and **customer websites** via Docker.
- Default language for code/comments/commits: **English**.
- Timezone & locale assumptions: **Europe/Zurich**, Swiss conventions where relevant.

## 1) Architecture & Baseline Assumptions
- OS: Ubuntu 22.04 LTS/24.04 LTS.
- Container runtime: **Docker + Docker Compose v2**.
- Reverse proxy: **NGINX** (containerized) fronting all services via per-site upstreams, HTTP on `:4480`, HTTPS on `:4443` if a shared ingress is needed; otherwise standard `80/443` when VPS owns the public IP directly.
- TLS: Prefer **wildcard certificates** already owned by FlowBiz. Fallback to Let's Encrypt (HTTP-01 or DNS-01).
- Networking: Dedicated user-defined bridge networks per stack + one **shared external network** `flowbiz_ext` for reverse proxy.
- Data paths: `/srv/<tenant>/<app>/{data,env,compose,logs}` with root-owned dirs and app-specific user if needed.
- Git model: **Monorepo** with `apps/`, `stacks/`, `packages/`, `infra/`, `docs/`.
- Git strategy: **Trunk-based** with short-lived branches, **Conventional Commits**, **SemVer** tags.

## 2) Repository Layout (Monorepo)
```
/ (repo root)
  .cursorrules              # ← this file
  .editorconfig
  .gitignore
  Makefile
  /infra                    # Ansible/Terraform + bootstrap scripts
    ansible/
    scripts/bootstrap_vps.sh
    scripts/new_stack.sh
  /stacks                   # Docker Compose stacks (n8n, dify, reverse-proxy, tenants)
    reverse-proxy/
      compose.yml
      nginx/
        conf.d/*.conf
        snippets/*.conf
      certs/                # mount read-only (do NOT commit certs)
    n8n/
      compose.yml
      .env.example
    dify/
      compose.yml
      .env.example
    llm-gateway/
      compose.yml
    templates/              # opinionated compose templates
      compose.base.yml
      compose.postgres.yml
      compose.redis.yml
      compose.queue.yml
  /apps                     # in-house tools (CLI, API, UI)
    vps-admin-cli/          # Python Typer-based CLI
    vps-admin-api/          # FastAPI admin API
    vps-admin-ui/           # Next.js/React dashboard
  /packages
    python/
      common/
    js/
      ui-components/
  /docs
    ADRs/
    runbooks/
```

## 3) Security & Compliance Defaults
- **No secrets in repo.** Use `.env` files in `/srv/.../env/` and pass via compose; provide `.env.example` in repo.
- Restrict permissions: `chmod 640` for `.env`, owned by `root:docker` or app user.
- Enable **UFW** with only required ports (80/443 or 4480/4443; SSH 22; custom if needed).
- **Fail2ban** on SSH + NGINX.
- All public services behind reverse proxy with **rate-limits** and **security headers**.
- Add **healthchecks** for every container; restart policies `unless-stopped`.
- Backups: Define **restic** profiles to S3-compatible storage (Infomaniak Object Storage). Schedule via `cron` container.
- Logging: Forward NGINX access/error and app logs to `/srv/<tenant>/<app>/logs`. Optionally add Loki/Promtail later.

## 4) NGINX Reverse Proxy Rules
- One NGINX container maps to `flowbiz_ext` network; each app joins `flowbiz_ext` and exposes upstream as `http://<service>:<port>`.
- Each site gets a **vhost** file in `nginx/conf.d/` named `<domain>.conf`.
- Enforce `HSTS`, `X-Frame-Options DENY`, `X-Content-Type-Options nosniff`, `Referrer-Policy same-origin`.
- Force HTTPS redirect. HTTP used only for ACME challenges if LE is used.
- Wildcard certs mounted read-only at `/etc/nginx/certs/`.

### vhost snippet (template)
```
server {
  listen 80;
  server_name {{DOMAIN}};
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name {{DOMAIN}};

  ssl_certificate     /etc/nginx/certs/{{CERT_NAME}}.crt;
  ssl_certificate_key /etc/nginx/certs/{{CERT_NAME}}.key;

  include /etc/nginx/snippets/security_headers.conf;

  location /healthz { return 200 "ok"; add_header Content-Type text/plain; }

  location / {
    proxy_pass http://{{UPSTREAM}};
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 120s;
  }
}
```

## 5) Compose Conventions
- **Naming:** `project_name` = `<tenant>-<app>` (e.g., `flowbiz-n8n`, `clientx-website`).
- **Networks:** attach to `flowbiz_ext` for reverse-proxy access; create a local network `<tenant>-<app>-net` for internal services.
- **Volumes:** bind-mount `/srv/<tenant>/<app>/data` and `/srv/<tenant>/<app>/logs`.
- **Env:** mount `/srv/<tenant>/<app>/env/.env` to service; never commit real env.
- **Healthcheck example:**
```
healthcheck:
  test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
  interval: 30s
  timeout: 5s
  retries: 5
  start_period: 20s
```

## 6) Standard Makefile Targets (root & in stacks/)
```
.PHONY: bootstrap new-stack up down logs ps prune lint format test release
bootstrap: ## Install base tools on a fresh VPS
	./infra/scripts/bootstrap_vps.sh

new-stack: ## Create a new stack from template
	./infra/scripts/new_stack.sh $(name)

up:
	docker compose up -d --build

down:
	docker compose down

logs:
	docker compose logs -f --tail=200

ps:
	docker compose ps

prune:
	docker system prune -af --volumes

lint:
	hadolint **/Dockerfile || true
	ruff check apps/ packages/
	npx eslint apps/**/*.ts apps/**/*.tsx || true

format:
	ruff format apps/ packages/
	npx prettier -w "**/*.{ts,tsx,js,jsx,json,md,yml,yaml}"

test:
	pytest -q || true

release:
	./infra/scripts/release.sh
```

## 7) Language & Tooling Standards
### Python
- Package manager: **uv** or **poetry** (choose one per app; default to **uv** for speed).
- Lint: **ruff**; Format: **ruff format**.
- Test: **pytest**; App server (APIs): **FastAPI + Uvicorn**.
- CLI: **Typer**; Config via `.env` + Pydantic Settings.

### Node/TS
- Manager: **pnpm**; Runtime: **Node 20 LTS**; UI: **Next.js + Tailwind**.
- Lint: **eslint**; Format: **prettier**.

### Docker
- Base images slim; non-root users; pin major versions; add `HEALTHCHECK`.
- Multi-stage builds; `NODE_ENV=production`; `PYTHONDONTWRITEBYTECODE=1`, `PYTHONUNBUFFERED=1`.
- Keep images <300MB where possible.

## 8) App Blueprints
### n8n stack
- Single container + Postgres + Redis (optional) with backups.
- Expose `/healthz` via NGINX; set `N8N_HOST`, `N8N_PROTOCOL=https`, `N8N_PORT=5678`.
- Persist `/home/node/.n8n`.

### Dify stack
- `api`, `web`, `worker`, `sandbox` + Postgres + Redis + optional vector DB (Qdrant/Weaviate).
- NGINX routes `/`→web, `/v1/`→api; ensure `CORS` and `X-Accel-Buffering off` for streams.
- Provide `.env.example` tailored to single-VPS deployment (no Certbot, reuse wildcard certs).

### Customer website
- `web` (Next.js or NGINX static) + optional `api` + DB. Default to **Postgres**.
- All domains subpath-safe; prefer root-domain or subdomain per tenant.

## 9) Secrets & Config
- `.env.example` must include **only placeholders**; real `.env` lives in `/srv/.../env/.env`.
- For production, support **sops**-encrypted env files (optional) & a `decrypt_env.sh` helper.
- Use **open-ports minimalism**. No DB ports exposed publicly; reverse proxy only ingress.

## 10) Backups & Disaster Recovery
- restic profile per stack:
  - Include `data/` and DB dumps (via cron `pg_dump` to `data/backups/`).
  - Exclude caches/tmp.
  - Daily snapshot, 7 daily / 4 weekly / 6 monthly retention.
- Basic restore docs under `/docs/runbooks/restore.md`.

## 11) Observability
- Add lightweight `/healthz` endpoints to every service.
- Access logs enabled on NGINX; structured JSON logs for APIs (pino/loguru).
- Optional: Loki/Promtail + Grafana; else use `docker logs` + fail2ban reports.

## 12) Git & CI
- **Conventional Commits** (`feat:`, `fix:`, `chore:`, `docs:`, `refactor:`, `perf:`, `test:`).
- PR checks: `lint`, `test`, `build` for affected apps.
- Release: tag `vMAJ.MIN.PATCH`; changelog via `git-cliff` or `semantic-release`.

## 13) Cursor Agent Behaviors (VERY IMPORTANT)
- When generating new service stacks:
  1. Create `stacks/<name>/compose.yml`, `.env.example`, `README.md` and if needed `nginx/conf.d/<domain>.conf`.
  2. Ensure **healthchecks**, **restart policies**, **volumes**, **networks** as specified.
  3. Provide **Makefile** or extend root Makefile targets to include the new stack.
- When writing Dockerfiles: use multi-stage, non-root user, minimal layers, add `HEALTHCHECK`.
- When producing `.env.example`: include clear comments and defaults that work locally with Compose.
- When touching NGINX: include `security_headers.conf` and strict TLS.
- Always output commands to deploy:
  - `mkdir -p /srv/<tenant>/<app>/{data,env,logs}`
  - `cp stacks/<app>/.env.example /srv/<tenant>/<app>/env/.env` (then edit)
  - `docker compose -f stacks/<app>/compose.yml up -d`
- Prefer **idempotent** bash scripts (`set -Eeuo pipefail`) and clear logging (`echo "[step] ..."`).

## 14) Coding Style & Docs
- Each stack must have a **README.md** with: purpose, env vars, ports, volumes, networks, deploy steps, backup notes.
- Python: type hints mandatory (`mypy` optional), docstrings for public functions.
- JS/TS: strict TypeScript where possible; export clear interfaces.
- Avoid over-abstraction; keep ops-first simplicity.

## 15) Tenant Onboarding Template
- Create folder `/srv/<tenant>/<app>/` and provision vhost.
- Generate `.env` from template; set domain, cert name, upstream service.
- If DB required:
  - Create dedicated DB user/password.
  - Disable public DB ports; only internal network.
- Add backup job & verify initial snapshot.

## 16) Known Provider Notes
- **Infomaniak VPS**: prefer their Object Storage for restic targets; check MTU and default networking; allow outbound SMTP only via provider policy or use relay.
- **Kamatera** (legacy): keep parity but plan migration; avoid provider-specific quirks.

## 17) Quality Gates (Do not merge if)
- No `.env.example` present.
- No healthcheck in Dockerfile/compose.
- No README for a new stack.
- Exposes DB to the internet.
- NGINX vhost without security headers/HSTS.

## 18) Quick Commands (Cheatsheet)
```
# Bootstrap a fresh VPS
make bootstrap

# Bring up the reverse proxy (once)
cd stacks/reverse-proxy && make up

# New stack from template
make new-stack name=clientx-website

# Deploy stack
cd stacks/clientx-website && make up

# Tail logs
cd stacks/clientx-website && make logs
```

## 19) Future Enhancements (Roadmap)
- Add GitOps (Watchtower or FluxCD-lite approach) for safe image updates.
- Central auth (Authelia/Keycloak) in front of admin UIs.
- Metrics stack (Prometheus + cAdvisor + Grafana) kept optional.
- Automated per-tenant billing exports (usage, storage, domains).

## 20) Non-Goals
- No Kubernetes on these VPS initially; keep it **simple Docker**.
- Avoid heavyweight service meshes/ingress controllers.

# End of vsa-cursor-rule.mdc
